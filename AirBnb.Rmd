---
title: "Fundamentals of Data Analysis"
author: "Final Group Project"
date: "30 Sep 2022"
output:
  html_document:
    
    highlight: zenburn
    theme: flatly
    toc: yes
    toc_float: yes
    number_sections: yes
    code_folding: show
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
# leave this chunk alone
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```

```{r}
library(knitr)
hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) {
    x = xfun::split_lines(x)
    # any lines wider than n should be wrapped
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})
```


# R Project


## Introduction

Short description about members 

#### Davide Mosezon
Born in Bologna in 1988 I'm a RFID Specialist in Lab ID Srl

#### Federica Mori
Born in Mantova in 1986, I'm an Innovation Manager at Confindustria Emilia-Romagna Ricerca. 

#### Daniel Mota De Carvalho
Lorem ipsum dolor sit amet, consectetur adipisci elit, sed do eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrum exercitationem ullamco laboriosam, nisi ut aliquid ex ea commodi consequatur. Duis aute irure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.

#### Virginia Mendon√ßa
Lorem ipsum dolor sit amet, consectetur adipisci elit, sed do eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrum exercitationem ullamco laboriosam, nisi ut aliquid ex ea commodi consequatur. Duis aute irure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.


```{r load-libraries, echo=FALSE}

library(tidyverse) # the usual stuff: dplyr, readr, and other goodies
library(lubridate) # to handle dates
library(GGally) # for correlation-scatter plot matrix
library(ggfortify) # to produce residual diagnostic plots
library(rsample) # to split dataframe in training- & testing sets
library(janitor) # clean_names()
library(broom) # use broom:augment() to get tidy table with regression output, residuals, etc
library(huxtable) # to get summary table of all models produced
library(kableExtra) # for formatting tables
library(moderndive) # for getting regression tables
library(skimr) # for skim
library(mosaic)
library(leaflet) # for interactive HTML maps
library(tidytext)
library(viridis)
library(vroom)
library(kableExtra)
library(performance)
library(patchwork)
```

## Exploratory Data Analysis

Add a short description about what data are and where come from

```{r cities_groups, message=FALSE, warning=FALSE}

listings <- vroom("http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz")%>% 
      #drop variables that contain 'scrape' in their column name
  select(- contains("scrape"))

listings <- listings %>% 
  mutate(price = parse_number(price))

```


```{r EDA_1, echo=FALSE}
#glimpse(listings)
#skim(listings)

```
How many variables/columns? 

```{r EDA_nVariables}

ncol(listings)

```

How many rows/observations?
```{r EDA_nObservations}

nrow(listings)

```
Which variables are numbers?

```{r EDA_numbers}

print(paste("List of the variables that are numbers"))

i=1
for(i in 1:ncol(listings)) {       # for-loop over columns
   if (is.numeric(listings[[i]]) == TRUE)
   {
    print(colnames(listings[i]))
  }
 }

```

Which are categorical or factor variables (numeric or character variables with variables that have a fixed and known set of possible values)?
```{r EDA_exploreVariables}

maxElements = 10

result <- apply(listings, 2, function(x) length(unique(x)))

print(paste("List of the variables with less than ",maxElements, "elements"))

for(i in 1:ncol(listings)) {       # for-loop over columns
 if(result[colnames(listings)[i]] < maxElements)
 {
   print(colnames(listings)[i])
 }
}

```

What are the correlations between variables? Does each scatterplot support a linear relationship between variables? Do any of the correlations appear to be conditional on the value of a categorical variable?

```{r EDA_correlations}

# finding significant correlations - to be completed
# listings %>% 
#   filter(number_of_reviews>50 & minimum_nights < 4 & price < 250) %>% 
#   select(minimum_nights,price,review_scores_rating, accommodates, availability_365,reviews_per_month) %>%
#   ggpairs(alpha = 0.3)
# listings%>%
#   select(price, accommodates, bedrooms, beds, availability_30, availability_60, availability_90, review_scores_rating, review_scores_accuracy, review_scores_communication, review_scores_cleanliness, review_scores_value, calculated_host_listings_count, calculated_host_listings_count_entire_homes)%>%
#   ggpairs(alpha = 0.3)


listings %>%
  filter(number_of_reviews>50) %>% 
  group_by(neighbourhood_cleansed) %>%
  summarise(medianPrice = median(price),
            medianRate = median(review_scores_rating, na.rm = TRUE),
            medianBedroom = median(bedrooms, na.rm = TRUE),
            medianMinimumNights = median(minimum_minimum_nights,na.rm = TRUE))

listings %>%
  filter(number_of_reviews>50) %>% 
  group_by(property_type) %>%
  summarise(medianPrice = median(price),
            medianRate = median(review_scores_rating, na.rm = TRUE),
            medianBedroom = median(bedrooms, na.rm = TRUE),
            medianMinimumNights = median(minimum_minimum_nights,na.rm = TRUE),
            totalAccomodations = count(property_type)) %>% 
  filter(totalAccomodations > 5)


listings %>% 
  group_by(neighbourhood_cleansed) %>% 
  summarise(medianPrice = median(price)) %>% 
  mutate(neighbourhood_cleansed = fct_reorder(neighbourhood_cleansed, medianPrice)) %>%
  ggplot(aes(x=medianPrice,y=neighbourhood_cleansed)) +
  geom_col() + 
  theme_classic() +
  labs(title = "Median price in Bologna",
        subtitle = "",
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") +
  theme(plot.caption = element_text(hjust= 1),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank())


listings %>% 
  group_by(neighbourhood_cleansed) %>% 
  summarise(totalAccomodation = count(neighbourhood_cleansed)) %>% 
  mutate(neighbourhood_cleansed = fct_reorder(neighbourhood_cleansed, totalAccomodation)) %>%
  ggplot(aes(x=totalAccomodation,y=neighbourhood_cleansed)) +
  geom_col() + 
  theme_classic() +
  labs(title = "Number of accomodations in Bologna", 
        subtitle = "", 
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") +
  theme(plot.caption = element_text(hjust= 1), 
        axis.title.x = element_blank(), #
        axis.title.y = element_blank())

listings %>% 
  filter(price<250) %>% 
  ggplot(aes(price,fill=neighbourhood_cleansed)) + 
  geom_histogram(binwidth = 10) +
  labs(title = "Distribution of price", 
        subtitle = "", 
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") + 
  theme(plot.caption = element_text(hjust= 1), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank()) +
  scale_fill_discrete(name = "Neighbourhood")


listings %>% 
  filter(number_of_reviews>50) %>% 
  ggplot(aes(review_scores_rating, fill = neighbourhood_cleansed)) +
  geom_density(position = "stack", alpha = 0.4) +
   labs(title = "Ratings with number of reviews more than 50", 
        subtitle = "", 
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") + 
  theme(plot.caption = element_text(hjust= 1), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank()) +
  scale_fill_discrete(name = "Neighbourhood")
  
```


## Handling missing values (NAs)

Airbnb is most commonly used for travel purposes, i.e., as an alternative to traditional hotels. We only want to include listings in our regression analysis that are intended for travel purposes:


Next, we look at the variable property_type. We can use the count function to determine how many categories there are their frequency. What are the top 4 most common property types? What proportion of the total listings do they make up?
```{r property_type_analysis}
listings %>% 
  group_by(property_type) %>% 
  summarise(countType = count(property_type)) %>%
  mutate(percentage = countType*100/sum(countType)) %>% 
  slice_max(order_by = countType, n=4)

```
Since the vast majority of the observations in the data are one of the top four or five property types, we would like to create a simplified version of property_type variable that has 5 categories: the top four categories and Other. Fill in the code below to create prop_type_simplified.

```{r prop_type_simplified}

listings <- listings %>%
  mutate(prop_type_simplified = case_when(
    property_type %in% c("Entire rental unit","Entire condo", "Private room in rental unit","Private room in condo") ~ property_type, 
    TRUE ~ "Other"
  ))

listings %>%
  count(property_type, prop_type_simplified) %>%
  arrange(desc(n))  
```


What are the most common values for the variable minimum_nights?

```{r commonValueforMinimumNights}

listings%>%
  group_by(minimum_nights)%>%
  summarise(tot_min_night=count(minimum_nights))%>%
  mutate(percentage = tot_min_night*100/sum(tot_min_night))%>%  
  arrange(desc(percentage))%>%
  slice_head(n=3)

```

Is there any value among the common values that stands out? What is the likely intended purpose for Airbnb listings with this seemingly unusual value for minimum_nights?

```{r lesscommonValueforMinimumNights}

listings%>%
  group_by(minimum_nights)%>%
  summarise(tot_min_night=count(minimum_nights))%>%
  mutate(percentage = tot_min_night*100/sum(tot_min_night))%>%  
  arrange(desc(minimum_nights))%>%
  slice_head(n=10)

```

*There are 33 solutions with a minimum nights of at least 30 days therefore comparable to rentals*

Filter the airbnb data so that it only includes observations with minimum_nights <= 4

```{r min_night_4}

listings<- listings%>%
  filter(minimum_nights<=4)

```



## Mapping
Visualisations of feature distributions and their relations are key to understanding a data set, and they can open up new lines of exploration. While we do not have time to go into all the wonderful geospatial visualisations one can do with R, you can use the following code to start with a map of your city, and overlay all AirBnB coordinates to get an overview of the spatial distribution of AirBnB rentals. For this visualisation we use the leaflet package, which includes a variety of tools for interactive maps, so you can easily zoom in-out, click on a point to get the actual AirBnB listing for that specific point, etc.

```{r mapping}
leaflet(data = filter(listings, minimum_nights <= 4)) %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 2, 
                   fillColor = "blue", 
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type)
```

## Regression Analysis

For the target variable Y, we will use the cost for two people to stay at an Airbnb location for four (4) nights.

Create a new variable called price_4_nights that uses price, and accomodares to calculate the total cost for two people to stay at the Airbnb property for 4 nights. This is the variable Y we want to explain.
```{r createprice_4_nights}
listings <- listings %>% 
  mutate(price_4_nights = price*4)


```

Use histograms or density plots to examine the distributions of price_4_nights and log(price_4_nights). Which variable should you use for the regression model? Why?

```{r histrogramPrice4Night}
g1 <- listings %>% 
  filter(accommodates>1, price<250) %>% 
  ggplot(aes(price_4_nights)) + 
  geom_histogram(binwidth = 10) +
  labs(title = "Distribution of price of 4 nights", 
        subtitle = "", 
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") + 
  theme(plot.caption = element_text(hjust= 1), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank())

g2 <- listings %>% 
  filter(accommodates>1, price<250) %>% 
  ggplot(aes(log(price_4_nights))) + 
  geom_histogram(binwidth = 10) +
  labs(title = "Distribution of log(price) of 4 nights", 
        subtitle = "", 
        caption = "Source: http://data.insideairbnb.com/italy/emilia-romagna/bologna/2022-06-11/data/listings.csv.gz") + 
  theme(plot.caption = element_text(hjust= 1), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank())
  
g1+g2
```


Fit a regression model called model1 with the following explanatory variables: prop_type_simplified, number_of_reviews, and review_scores_rating.

```{r regressionmodel1}

#skim(listings)

#model1 <- listings %>% 
#  drop_na(review_scores_rating) %>% 
#  lm(prop_type_simplified ~ number_of_reviews + review_scores_rating, data = listings)
  
#msummary(model1)

```


Interpret the coefficient review_scores_rating in terms of price_4_nights.
Interpret the coefficient of prop_type_simplified in terms of price_4_nights.
We want to determine if room_type is a significant predictor of the cost for 4 nights, given everything else in the model. Fit a regression model called model2 that includes all of the explanantory variables in model1 plus room_type.